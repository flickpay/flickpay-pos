<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta
    http-equiv="Content-Security-Policy"
    content="default-src 'self';
             style-src 'self' 'unsafe-inline';
             script-src 'self' 'unsafe-inline';
             font-src 'self' data:;"
  />

  <title>FlickpayPOS Settings</title>

  <style>
    :root {
      --bg: #1B1D26;
      --panel: #262A36;
      --surface: #3C3E4B;
      --surface2: #5A5E6B;

      --text: #E4E4E4;
      --muted: #B1B3BC;

      --accent: #1E90E8;

      --ok: #1dc959;
      --err: #ff5757;

      --radius: 6px;

      --shadow: 0 18px 60px rgba(0,0,0,0.45);
      --ring: 0 0 0 3px rgba(30, 144, 232, 0.25);

      --sidebar-w: 300px;
    }

    /* === Helvetica Neue (local bundle) === */
    @font-face {
      font-family: "Helvetica Neue";
      src: url("./assets/fonts/helveticaneue-light.woff2") format("woff2");
      font-weight: 300;
      font-style: normal;
      font-display: swap;
    }
    @font-face {
      font-family: "Helvetica Neue";
      src: url("./assets/fonts/helveticaneue-bold.woff2") format("woff2");
      font-weight: 700;
      font-style: normal;
      font-display: swap;
    }

    * { box-sizing: border-box; }

    html, body {
      height: 100%;
      margin: 0;
      overflow: hidden;
      background: var(--bg);
      color: var(--text);
      font-family:
        "Helvetica Neue",
        Helvetica,
        Arial,
        system-ui,
        -apple-system,
        BlinkMacSystemFont,
        "Segoe UI",
        sans-serif;
      font-weight: 300;
    }

    .app {
      height: 100%;
      display: grid;
      grid-template-columns: var(--sidebar-w) 1fr;
      position: relative;
    }

    /* ===== Top-right close (modal) ===== */
    .closeX {
      position: absolute;
      top: 12px;
      right: 12px;
      width: 34px;
      height: 34px;
      border-radius: var(--radius);
      border: 0;
      background: var(--surface);
      color: rgba(255,255,255,0.92);
      cursor: pointer;
      display: grid;
      place-items: center;
      font-size: 16px;
      font-weight: 700;
      line-height: 1;
      transition: transform 0.08s ease, filter 0.15s ease, background 0.15s ease;
      z-index: 5;
    }
    .closeX:hover { background: var(--surface2); }
    .closeX:active { transform: scale(0.99); filter: brightness(0.98); }

    /* ===== Sidebar ===== */
    .sidebar {
      background: var(--panel);
      border-right: 1px solid rgba(255,255,255,0.06);
      display: flex;
      flex-direction: column;
      min-width: 0;
    }

    .sidebarTop {
      padding: 16px 10px 12px;
      border-bottom: 1px solid rgba(255,255,255,0.06);
    }

    .sidebarTitle {
      padding: 0 14px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      line-height: 1.1;
      min-width: 0;
    }

    .sidebarTitle .t1 {
      font-weight: 700;
      letter-spacing: 0.2px;
      font-size: 20px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .sidebarTitle .t2row {
      display: flex;
      align-items: baseline;
      gap: 8px;
      min-width: 0;
      flex-wrap: nowrap;
    }

    .sidebarTitle .t2 {
      font-size: 13px;
      color: var(--muted);
      font-weight: 700;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      min-width: 0;
    }

    .sidebarTitle .t3 {
      font-size: 13px;
      color: rgba(255,255,255,0.55);
      font-weight: 700;
      white-space: nowrap;
      flex: 0 0 auto;
    }

    .nav {
      padding: 12px 10px;
      overflow: auto;
      overscroll-behavior: contain;
    }

    .nav::-webkit-scrollbar { width: 10px; height: 10px; }
    .nav::-webkit-scrollbar-thumb {
      background: rgba(255,255,255,0.16);
      border-radius: 999px;
      border: 2px solid rgba(0,0,0,0);
      background-clip: padding-box;
    }
    .nav::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.24); }
    .nav::-webkit-scrollbar-track { background: rgba(0,0,0,0); }

    .navItem {
      width: 100%;
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 14px;
      border-radius: var(--radius);
      border: 0;
      background: transparent;
      color: var(--text);
      cursor: pointer;
      font-weight: 700;
      font-size: 16px;
      text-align: left;
      position: relative;
      transition: background 0.15s ease;
    }

    .navItem:hover { background: rgba(255,255,255,0.04); }

    .navItem[aria-selected="true"] {
      background: rgba(30, 144, 232, 0.12);
    }

    .navItem[aria-selected="true"]::after {
      content: "";
      position: absolute;
      right: 6px;
      top: 12px;
      bottom: 12px;
      width: 4px;
      border-radius: 999px;
      background: var(--accent);
    }

    .navIcon {
      width: 22px;
      height: 22px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      flex: 0 0 auto;
    }

    .navIcon img {
      width: 22px;
      height: 22px;
      display: block;
      filter: invert(1);
      opacity: 0.92;
    }

    /* ===== Main ===== */
    .main {
      background: var(--bg);
      min-width: 0;
      display: grid;
      grid-template-rows: 1fr auto;
    }

    .scrollHost {
      overflow: auto;
      overscroll-behavior: contain;
      padding: 22px 22px 10px;
    }

    .scrollHost::-webkit-scrollbar { width: 10px; height: 10px; }
    .scrollHost::-webkit-scrollbar-thumb {
      background: rgba(255,255,255,0.16);
      border-radius: 999px;
      border: 2px solid rgba(0,0,0,0);
      background-clip: padding-box;
    }
    .scrollHost::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.24); }
    .scrollHost::-webkit-scrollbar-track { background: rgba(0,0,0,0); }

    .content {
      max-width: 980px;
      margin: 0 auto;
      padding-bottom: 18px;
    }

    .pageTitle {
      font-size: 44px;
      font-weight: 700;
      letter-spacing: -0.6px;
      margin: 6px 0 18px;
    }

    .section {
      background: var(--panel);
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
      margin-bottom: 14px;
    }

    .sectionHead {
      padding: 14px 16px;
      border-bottom: 1px solid rgba(255,255,255,0.06);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 14px;
    }

    .sectionHead .h {
      display: flex;
      flex-direction: column;
      gap: 4px;
      min-width: 0;
    }

    .sectionHead .title {
      font-size: 16px;
      font-weight: 700;
      letter-spacing: 0.2px;
    }

    .sectionHead .sub {
      font-size: 12px;
      color: var(--muted);
      line-height: 1.35;
      font-weight: 300;
    }

    .sectionBody { padding: 16px; }

    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
    }

    @media (max-width: 860px) {
      :root { --sidebar-w: 260px; }
      .pageTitle { font-size: 36px; }
      .grid { grid-template-columns: 1fr; }
    }

    label {
      display: block;
      font-size: 13px;
      color: var(--muted);
      margin: 10px 0 6px;
      font-weight: 700;
      letter-spacing: 0.2px;
    }

    input[type="text"],
    input[type="password"] {
      width: 100%;
      padding: 12px 12px;
      border-radius: var(--radius);
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.18);
      color: var(--text);
      font-size: 14px;
      outline: none;
      transition: border-color 0.15s, box-shadow 0.15s, background 0.15s;
      font-weight: 300;
    }

    input::placeholder { color: rgba(255,255,255,0.35); }

    input:focus {
      border-color: rgba(30, 144, 232, 0.55);
      box-shadow: var(--ring);
      background: rgba(0,0,0,0.22);
    }

    .mode-buttons {
      display: flex;
      gap: 10px;
      margin-top: 6px;
    }

    .mode-btn {
      flex: 1;
      padding: 12px 12px;
      border-radius: var(--radius);
      border: 0;
      background: var(--surface);
      color: var(--text);
      cursor: pointer;
      font-size: 14px;
      font-weight: 700;
      transition: transform 0.08s ease, filter 0.15s ease, background 0.15s ease;
    }

    .mode-btn:hover { background: var(--surface2); }
    .mode-btn:active { transform: scale(0.99); filter: brightness(0.98); }

    .mode-btn.selected {
      background: var(--accent);
      color: #fff;
    }
    .mode-btn.selected:hover { filter: brightness(1.06); }

    .tokenRow {
      margin-top: 12px;
      padding: 12px;
      border-radius: var(--radius);
      border: 1px solid rgba(255, 255, 255, 0.08);
      background: rgba(255,255,255,0.03);
      display: none;
    }

    .tokenHeader {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 8px;
    }

    .tokenHeader .title {
      font-size: 13px;
      color: var(--muted);
      font-weight: 700;
      letter-spacing: 0.2px;
    }

    .toggleSmall {
      border: 0;
      background: var(--surface);
      color: rgba(255, 255, 255, 0.92);
      border-radius: var(--radius);
      padding: 7px 10px;
      font-weight: 700;
      font-size: 12px;
      cursor: pointer;
      transition: filter 0.15s ease, transform 0.08s ease, background 0.15s ease;
      min-width: 64px;
      text-align: center;
    }
    .toggleSmall:hover { background: var(--surface2); }
    .toggleSmall:active { transform: scale(0.99); filter: brightness(0.98); }

    .hint {
      padding: 12px;
      border-radius: var(--radius);
      border: 1px solid rgba(255, 255, 255, 0.08);
      background: rgba(255,255,255,0.03);
      color: rgba(255,255,255,0.78);
      font-size: 12px;
      line-height: 1.45;
      font-weight: 300;
    }

    code {
      background: rgba(255, 255, 255, 0.10);
      padding: 2px 7px;
      border-radius: var(--radius);
      color: rgba(255, 255, 255, 0.92);
      font-weight: 700;
    }

    .supportKey {
      margin-top: 8px;
      color: rgba(255, 255, 255, 0.88);
      font-weight: 700;
    }

    .actionsBar {
      border-top: 1px solid rgba(255,255,255,0.06);
      background: rgba(0,0,0,0.35);
      backdrop-filter: blur(12px);
      padding: 14px 22px;
    }

    .actionsInner {
      max-width: 980px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    #status {
      font-size: 13px;
      color: var(--muted);
      min-height: 18px;
      flex: 1 1 auto;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-weight: 700;
    }
    #status.ok { color: var(--ok); }
    #status.error { color: var(--err); }

    .btnRow { display: flex; gap: 10px; flex: 0 0 auto; }

    button.primary {
      padding: 11px 16px;
      border-radius: var(--radius);
      border: 0;
      cursor: pointer;
      font-weight: 700;
      font-size: 14px;
      color: #fff;
      background: var(--accent);
      transition: transform 0.08s ease, filter 0.15s ease;
      min-width: 110px;
    }
    button.primary:hover { filter: brightness(1.06); }
    button.primary:active { transform: scale(0.99); filter: brightness(0.98); }
    button.primary:disabled { opacity: 0.65; cursor: default; }

    button.secondary {
      padding: 11px 14px;
      border-radius: var(--radius);
      border: 0;
      cursor: pointer;
      font-weight: 700;
      font-size: 14px;
      color: var(--text);
      background: var(--surface);
      transition: transform 0.08s ease, filter 0.15s ease, background 0.15s ease;
      min-width: 140px;
    }
    button.secondary:hover { background: var(--surface2); }
    button.secondary:active { transform: scale(0.99); filter: brightness(0.98); }
    button.secondary:disabled { opacity: 0.65; cursor: default; }

    .tabPanel { display: none; }
    .tabPanel.active { display: block; }

    /* ===== Logs box ===== */
    .logBox {
      margin: 0;
      overflow: auto;
      padding: 12px;
      border-radius: var(--radius);
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.18);
      color: rgba(255,255,255,0.88);
      font-size: 12px;
      line-height: 1.4;
      white-space: pre-wrap;
      word-break: break-word;
      user-select: text;
    }

    /* ✅ Logs layout: buttons + scrollable log box */
    .logControls {
      display: flex;
      gap: 10px;
      margin-bottom: 12px;
      flex: 0 0 auto;
    }
    .logsWrap {
      display: flex;
      flex-direction: column;
      height: 58vh;            /* keeps it inside modal */
      min-height: 320px;
      max-height: 68vh;
    }
    .logsWrap .logBox {
      flex: 1 1 auto;          /* the box takes remaining height */
      min-height: 180px;
    }
  </style>
</head>

<body>
  <div class="app" id="appRoot">
    <button class="closeX" type="button" id="closeX" aria-label="Close">✕</button>

    <aside class="sidebar">
      <div class="sidebarTop">
        <div class="sidebarTitle">
          <div class="t1">Settings</div>
          <div class="t2row">
            <div class="t2">FlickpayPOS</div>
            <div class="t3" id="sidebarVersion"></div>
          </div>
        </div>
      </div>

      <nav class="nav" role="tablist" aria-label="Settings sections">
        <button class="navItem" type="button" role="tab" id="tabIdentity" aria-controls="panelIdentity" aria-selected="true" data-tab="identity">
          <span class="navIcon" aria-hidden="true">
            <img src="assets/icons/user.svg" alt="" aria-hidden="true" />
          </span>
          <span>Account</span>
        </button>

        <button class="navItem" type="button" role="tab" id="tabDisplays" aria-controls="panelDisplays" aria-selected="false" data-tab="displays">
          <span class="navIcon" aria-hidden="true">
            <img src="assets/icons/desktop.svg" alt="" aria-hidden="true" />
          </span>
          <span>Display(s)</span>
        </button>

        <button class="navItem" type="button" role="tab" id="tabRemote" aria-controls="panelRemote" aria-selected="false" data-tab="remote">
          <span class="navIcon" aria-hidden="true">
            <img src="assets/icons/wrench.svg" alt="" aria-hidden="true" />
          </span>
          <span>Remote</span>
        </button>

        <button class="navItem" type="button" role="tab" id="tabLogs" aria-controls="panelLogs" aria-selected="false" data-tab="logs">
          <span class="navIcon" aria-hidden="true">
            <img src="assets/icons/clipboard-list.svg" alt="" aria-hidden="true" />
          </span>
          <span>Logs</span>
        </button>

        <button class="navItem" type="button" role="tab" id="tabPrefs" aria-controls="panelPrefs" aria-selected="false" data-tab="prefs">
          <span class="navIcon" aria-hidden="true">
            <img src="assets/icons/gear.svg" alt="" aria-hidden="true" />
          </span>
          <span>Preferences</span>
        </button>
      </nav>
    </aside>

    <main class="main">
      <div class="scrollHost">
        <div class="content">
          <form id="config-form">

            <section class="tabPanel active" id="panelIdentity" role="tabpanel" aria-labelledby="tabIdentity" data-panel="identity">
              <div class="pageTitle">Account</div>

              <div class="section">
                <div class="sectionHead">
                  <div class="h">
                    <div class="title">Account & POS Account</div>
                    <div class="sub">Used to link this device to the correct account and POS.</div>
                  </div>
                </div>
                <div class="sectionBody">
                  <div class="grid">
                    <div>
                      <label for="account">Account</label>
                      <input type="text" id="account" autocomplete="off" placeholder="e.g. acme" />
                    </div>

                    <div>
                      <label for="posId">POS ID</label>
                      <input type="text" id="posId" autocomplete="off" placeholder="e.g. 12345" />
                    </div>
                  </div>
                </div>
              </div>
            </section>

            <section class="tabPanel" id="panelDisplays" role="tabpanel" aria-labelledby="tabDisplays" data-panel="displays">
              <div class="pageTitle">Displays</div>

              <div class="section">
                <div class="sectionHead">
                  <div class="h">
                    <div class="title">Main Display Mode</div>
                    <div class="sub">Choose how screen 1 behaves (operator POS or self-service kiosk).</div>
                  </div>
                </div>
                <div class="sectionBody">
                  <label>Main Display Mode</label>
                  <div class="mode-buttons">
                    <button type="button" class="mode-btn" id="modePos">Operator POS</button>
                    <button type="button" class="mode-btn" id="modeSelf">Self-Service Kiosk</button>
                  </div>

                  <div class="tokenRow" id="tokenRow">
                    <div class="tokenHeader">
                      <div class="title">Self-Service Access Token</div>
                      <button type="button" class="toggleSmall" id="toggleToken">Show</button>
                    </div>

                    <input type="password" id="accessToken" autocomplete="off" placeholder="Paste access_token here" />
                  </div>
                </div>
              </div>
            </section>

            <section class="tabPanel" id="panelRemote" role="tabpanel" aria-labelledby="tabRemote" data-panel="remote">
              <div class="pageTitle">Remote</div>

              <div class="section">
                <div class="sectionHead">
                  <div class="h">
                    <div class="title">Rysen Remote</div>
                    <div class="sub">Use this key when a support engineer requests remote access.</div>
                  </div>
                </div>
                <div class="sectionBody">
                  <div class="hint">
                    <div class="supportKey">Rysen Remote Support Key:</div>
                    <code>mzlTticCWVp3jomxFSNZO+XgWyGgFFoCqjA6wktJ6rk=</code>
                  </div>
                </div>
              </div>
            </section>

            <!-- ✅ LOGS TAB PANEL -->
            <section class="tabPanel" id="panelLogs" role="tabpanel" aria-labelledby="tabLogs" data-panel="logs">
              <div class="pageTitle">Logs</div>

              <div class="section">
                <div class="sectionHead">
                  <div class="h">
                    <div class="title">Diagnostics</div>
                    <div class="sub">Latest app logs (updates, errors, etc.).</div>
                  </div>
                </div>
                <div class="sectionBody">
                  <div class="logsWrap">
                    <div class="logControls">
                      <button type="button" class="secondary" id="reloadLogs" style="min-width: 150px;">Reload Logs</button>
                      <button type="button" class="secondary" id="copyLogs" style="min-width: 150px;">Copy</button>
                    </div>
                    <pre id="logBox" class="logBox">No logs found.</pre>
                  </div>
                </div>
              </div>
            </section>

            <section class="tabPanel" id="panelPrefs" role="tabpanel" aria-labelledby="tabPrefs" data-panel="prefs">
              <div class="pageTitle">Preferences</div>

              <div class="section">
                <div class="sectionHead">
                  <div class="h">
                    <div class="title">Keyboard Shortcuts</div>
                    <div class="sub">Quick ways to access settings on a locked-down system.</div>
                  </div>
                </div>
                <div class="sectionBody">
                  <div class="hint">
                    <div><code>Ctrl</code> + <code>Alt</code> + <code>S</code> | Settings</div>
                    <div style="margin-top:8px;"><code>Ctrl</code> + <code>Alt</code> + <code>R</code> | Reload</div>
                    <div style="margin-top:8px;"><code>Ctrl</code> + <code>Alt</code> + <code>Q</code> | Quit</div>
                  </div>
                </div>
              </div>

              <div class="section">
                <div class="sectionHead">
                  <div class="h">
                    <div class="title">Reset</div>
                    <div class="sub">Clear cache, cookies, local storage, and service workers for this app.</div>
                  </div>
                </div>
                <div class="sectionBody">
                  <button type="button" class="secondary" id="clearData">
                    Clear Cache &amp; History
                  </button>
                </div>
              </div>
            </section>

          </form>
        </div>
      </div>

      <div class="actionsBar">
        <div class="actionsInner">
          <div id="status"></div>
          <div class="btnRow">
            <button type="submit" class="primary" id="save" form="config-form">Save</button>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script>
    const form = document.getElementById("config-form");
    const statusEl = document.getElementById("status");

    const accountInput = document.getElementById("account");
    const posIdInput = document.getElementById("posId");

    const modePosBtn = document.getElementById("modePos");
    const modeSelfBtn = document.getElementById("modeSelf");

    const tokenRow = document.getElementById("tokenRow");
    const accessTokenInput = document.getElementById("accessToken");
    const toggleTokenBtn = document.getElementById("toggleToken");

    const saveBtn = document.getElementById("save");
    const clearBtn = document.getElementById("clearData");

    const sidebarVersionEl = document.getElementById("sidebarVersion");
    const logBox = document.getElementById("logBox");

    const reloadLogsBtn = document.getElementById("reloadLogs");
    const copyLogsBtn = document.getElementById("copyLogs");

    let screen1Mode = "pos";
    let tokenVisible = false;

    function setStatus(msg, type) {
      statusEl.textContent = msg || "";
      statusEl.className = "";
      if (type) statusEl.classList.add(type);
    }

    function applyModeUi() {
      modePosBtn.classList.toggle("selected", screen1Mode === "pos");
      modeSelfBtn.classList.toggle("selected", screen1Mode === "self");
      tokenRow.style.display = screen1Mode === "self" ? "block" : "none";

      if (screen1Mode !== "self") {
        tokenVisible = false;
        accessTokenInput.type = "password";
        toggleTokenBtn.textContent = "Show";
      }
    }

    function setMode(mode) {
      screen1Mode = mode === "self" ? "self" : "pos";
      applyModeUi();
    }

    function closeModal() {
      window.location.href = "pos://closeModal";
    }

    async function loadVersion() {
      try {
        if (!window.flickpayConfig?.getAppVersion) return;
        const v = await window.flickpayConfig.getAppVersion();
        if (sidebarVersionEl) sidebarVersionEl.textContent = `v${v}`;
      } catch {}
    }

    async function loadConfig() {
      try {
        const cfg = await window.flickpayConfig.getConfig();
        accountInput.value = cfg?.account || "";
        posIdInput.value = cfg?.posId || "";
        accessTokenInput.value = cfg?.accessToken || "";
        setMode(cfg?.screen1Mode === "self" ? "self" : "pos");
      } catch {
        setStatus("Could not load current settings.", "error");
        setMode("pos");
      }
    }

    async function loadLogs() {
      try {
        if (!window.flickpayConfig?.readAppLog) {
          if (logBox) logBox.textContent = "No logs found.";
          return;
        }
        const res = await window.flickpayConfig.readAppLog();
        if (res?.ok && typeof res.text === "string" && res.text.trim()) {
          logBox.textContent = res.text;
        } else {
          logBox.textContent = "No logs found.";
        }
      } catch {
        if (logBox) logBox.textContent = "No logs found.";
      }
    }

    async function copyLogs() {
      try {
        const text = (logBox && logBox.textContent) ? logBox.textContent : "";
        if (!text.trim()) return;

        await navigator.clipboard.writeText(text);

        if (copyLogsBtn) {
          const old = copyLogsBtn.textContent;
          copyLogsBtn.textContent = "Copied";
          setTimeout(() => { copyLogsBtn.textContent = old || "Copy"; }, 1200);
        }
      } catch {
        // fallback (older Chromium / permissions)
        try {
          const ta = document.createElement("textarea");
          ta.value = (logBox && logBox.textContent) ? logBox.textContent : "";
          ta.style.position = "fixed";
          ta.style.left = "-9999px";
          document.body.appendChild(ta);
          ta.focus();
          ta.select();
          document.execCommand("copy");
          document.body.removeChild(ta);

          if (copyLogsBtn) {
            const old = copyLogsBtn.textContent;
            copyLogsBtn.textContent = "Copied";
            setTimeout(() => { copyLogsBtn.textContent = old || "Copy"; }, 1200);
          }
        } catch {}
      }
    }

    modePosBtn.onclick = () => setMode("pos");
    modeSelfBtn.onclick = () => setMode("self");

    toggleTokenBtn.onclick = () => {
      tokenVisible = !tokenVisible;
      accessTokenInput.type = tokenVisible ? "text" : "password";
      toggleTokenBtn.textContent = tokenVisible ? "Hide" : "Show";
    };

    if (reloadLogsBtn) reloadLogsBtn.onclick = () => loadLogs();
    if (copyLogsBtn) copyLogsBtn.onclick = () => copyLogs();

    form.onsubmit = async (e) => {
      e.preventDefault();
      saveBtn.disabled = true;
      if (clearBtn) clearBtn.disabled = true;
      setStatus("");

      try {
        const res = await window.flickpayConfig.saveConfig({
          account: accountInput.value.trim(),
          posId: posIdInput.value.trim(),
          accessToken: accessTokenInput.value.trim(),
          screen1Mode,
        });

        setStatus(
          res?.success ? "Saved. Displays updated." : (res?.error || "Save failed."),
          res?.success ? "ok" : "error"
        );
      } catch {
        setStatus("Error while saving settings.", "error");
      } finally {
        saveBtn.disabled = false;
        if (clearBtn) clearBtn.disabled = false;
      }
    };

    if (clearBtn) {
      clearBtn.onclick = async () => {
        if (!window.flickpayConfig?.clearAppData) {
          setStatus("This build does not support clearing app data yet.", "error");
          return;
        }

        const ok = confirm(
          "Clear cache, cookies, local storage, and service workers for this app?\n\n" +
            "This may sign you out and will refresh both screens."
        );
        if (!ok) return;

        saveBtn.disabled = true;
        clearBtn.disabled = true;
        setStatus("Clearing cache & history.", "");

        try {
          const res = await window.flickpayConfig.clearAppData();
          if (res?.success) setStatus("Cleared. Reloading displays.", "ok");
          else setStatus(res?.error || "Clear failed.", "error");
        } catch {
          setStatus("Error while clearing app data.", "error");
        } finally {
          saveBtn.disabled = false;
          clearBtn.disabled = false;
        }
      };
    }

    const tabButtons = Array.from(document.querySelectorAll(".navItem[role='tab']"));
    const panels = Array.from(document.querySelectorAll(".tabPanel"));

    function setTab(name) {
      tabButtons.forEach(btn => {
        const isActive = btn.dataset.tab === name;
        btn.setAttribute("aria-selected", String(isActive));
      });
      panels.forEach(p => {
        p.classList.toggle("active", p.dataset.panel === name);
      });

      if (name === "logs") loadLogs();
    }

    tabButtons.forEach(btn => {
      btn.addEventListener("click", () => setTab(btn.dataset.tab));
    });

    document.getElementById("closeX")?.addEventListener("click", closeModal);

    loadVersion();
    loadConfig();
    applyModeUi();
  </script>
</body>
</html>
