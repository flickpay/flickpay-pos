<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self'; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline'; font-src 'self' data:">
  <title>Enter PIN</title>

  <style>
    :root{
      /* Match Settings theme tokens */
      --bg: #1B1D26;
      --panel: #262A36;
      --surface: #3C3E4B;
      --surface2: #5A5E6B;

      --text: #E4E4E4;
      --muted: #B1B3BC;

      --accent: #1E90E8;

      --ok:#1dc959;
      --err:#ff5757;

      --radius:6px;

      --shadow: 0 18px 60px rgba(0,0,0,0.45);
      --ring: 0 0 0 3px rgba(30, 144, 232, 0.25);
    }

    /* Helvetica Neue (local bundle) */
    @font-face {
      font-family: "Helvetica Neue";
      src: url("./assets/fonts/helveticaneue-light.woff2") format("woff2");
      font-weight: 300;
      font-style: normal;
      font-display: swap;
    }
    @font-face {
      font-family: "Helvetica Neue";
      src: url("./assets/fonts/helveticaneue-bold.woff2") format("woff2");
      font-weight: 700;
      font-style: normal;
      font-display: swap;
    }

    * { box-sizing: border-box; }

    html, body{
      height: 100%;
      margin: 0;
      overflow: hidden;
      background: var(--bg);
      color: var(--text);
      font-family:
        "Helvetica Neue",
        Helvetica,
        Arial,
        system-ui,
        -apple-system,
        BlinkMacSystemFont,
        "Segoe UI",
        sans-serif;
      font-weight: 300; /* Light default */
    }

    body{
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 50px;
      position: relative; /* anchor for X button */
    }

    /* === Pixel-perfect match to config.html close button === */
    .closeX {
      position: absolute;
      top: 12px;
      right: 12px;
      width: 34px;
      height: 34px;
      border-radius: var(--radius);
      border: 0;
      background: var(--surface);
      color: rgba(255,255,255,0.92);
      cursor: pointer;
      display: grid;
      place-items: center;
      font-size: 16px;
      font-weight: 700;
      line-height: 1;
      transition: transform 0.08s ease, filter 0.15s ease, background 0.15s ease;
      z-index: 5;
    }
    .closeX:hover { background: var(--surface2); }
    .closeX:active { transform: scale(0.99); filter: brightness(0.98); }

    /* Centered pin container */
    .shell{
      width: 100%;
      height: 100%;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    .card{
      width: min(520px, 100%);
      background: var(--panel);
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 22px;
      display:flex;
      flex-direction:column;
      gap: 16px;
    }

    .top{
      text-align:center;
      padding: 6px 8px 2px;
    }

    h1{
      margin: 0;
      font-size: 26px;
      font-weight: 700;
      letter-spacing: -0.2px;
    }

    p{
      margin: 6px 0 0;
      font-size: 13px;
      color: var(--muted);
      font-weight: 300;
      line-height: 1.35;
    }

    /* PIN dots row */
    .pinRow{
      width: 100%;
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      margin-top: 2px;
    }

    .digit{
      height: 74px;
      border-radius: var(--radius);
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.18);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 34px;
      font-weight: 700;
      letter-spacing: 2px;

      /* smoother premium transitions */
      transition:
        border-color .15s,
        box-shadow .15s,
        background .15s,
        transform .10s,
        font-size .10s;
    }

    .digit.filled{
      border-color: rgba(30, 144, 232, 0.45);
      box-shadow: var(--ring);
      background: rgba(0,0,0,0.22);

      /* bigger dot + slight pop */
      font-size: 52px;
      line-height: 1;
      transform: scale(1.02);
    }

    .status{
      min-height: 18px;
      font-size: 13px;
      color: var(--muted);
      text-align:center;
      font-weight: 700; /* matches config status */
      margin-top: -2px;
    }
    .status.error{ color: var(--err); }
    .status.ok{ color: var(--ok); }

    /* PIN pad */
    .pinPad{
      width: 100%;
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
    }

    .pinKey{
      height: 62px;
      border-radius: var(--radius);
      border: 0; /* flat like POS */
      background: var(--surface);
      color: var(--text);
      font-size: 18px;
      font-weight: 700;
      cursor: pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      transition: transform 0.08s ease, filter 0.15s ease, background 0.15s ease;
      user-select: none;
    }
    .pinKey:hover { background: var(--surface2); }
    .pinKey:active { transform: scale(0.99); filter: brightness(0.98); }

    .pinKey.secondary{
      font-size: 14px;
      letter-spacing: 0.2px;
    }

    /* Bottom action */
    .actions{
      width: 100%;
      display:flex;
      gap: 12px;
      margin-top: 2px;
    }

    button.primary{
      width: 100%;
      height: 62px;
      border-radius: var(--radius);
      border: 0;
      font-size: 16px;
      font-weight: 700;
      color: #fff;
      cursor:pointer;
      background: var(--accent); /* flat blue like Save */
      transition: transform 0.08s ease, filter 0.15s ease;
    }
    button.primary:hover { filter: brightness(1.06); }
    button.primary:active { transform: scale(0.99); filter: brightness(0.98); }
    button.primary:disabled { opacity: .65; cursor: default; }

    /* Slightly improve proportional look on small windows */
    @media (max-height: 720px){
      body{ padding: 28px; }
      .digit{ height: 66px; }
      .pinKey, button.primary{ height: 58px; }
    }
  </style>
</head>

<body>
  <!-- X button (must match config) -->
  <button class="closeX" type="button" id="closeX" aria-label="Close">✕</button>

  <div class="shell">
    <div class="card" id="card">

      <div class="top">
        <h1>Enter PIN</h1>
        <p>Enter your 4-digit PIN to open settings.</p>
      </div>

      <div class="pinRow">
        <div class="digit" id="d0"></div>
        <div class="digit" id="d1"></div>
        <div class="digit" id="d2"></div>
        <div class="digit" id="d3"></div>
      </div>

      <div class="status" id="status"></div>

      <div class="pinPad" aria-label="PIN keypad">
        <button class="pinKey" data-key="1" type="button">1</button>
        <button class="pinKey" data-key="2" type="button">2</button>
        <button class="pinKey" data-key="3" type="button">3</button>
        <button class="pinKey" data-key="4" type="button">4</button>
        <button class="pinKey" data-key="5" type="button">5</button>
        <button class="pinKey" data-key="6" type="button">6</button>
        <button class="pinKey" data-key="7" type="button">7</button>
        <button class="pinKey" data-key="8" type="button">8</button>
        <button class="pinKey" data-key="9" type="button">9</button>
        <button class="pinKey secondary" data-action="clear" type="button">Clear</button>
        <button class="pinKey" data-key="0" type="button">0</button>
        <button class="pinKey secondary" data-action="back" type="button">⌫</button>
      </div>

      <div class="actions">
        <button class="primary" id="unlock" type="button">Unlock</button>
      </div>

    </div>
  </div>

  <script>
    let pin = "";

    const digits = [0,1,2,3].map(i => document.getElementById("d"+i));
    const unlockBtn = document.getElementById("unlock");
    const card = document.getElementById("card");
    const statusEl = document.getElementById("status");

    function setStatus(msg, type) {
      statusEl.textContent = msg || "";
      statusEl.className = "status" + (type ? " " + type : "");
    }

    function renderPin(p){
      const v = String(p || "").replace(/\D/g, "").slice(0,4);
      digits.forEach((d,i)=>{
        d.textContent = v[i] ? "•" : "";
        d.classList.toggle("filled", !!v[i]);
      });
    }

    function setPin(next){
      pin = String(next || "").replace(/\D/g, "").slice(0,4);
      renderPin(pin);
      setStatus("");
    }

    async function tryUnlock(){
      renderPin(pin);

      if (pin.length !== 4) {
        setStatus("Enter 4 digits.", "error");
        return;
      }

      unlockBtn.disabled = true;
      setStatus("");

      try {
        const res = await window.flickpayConfig.verifyPin(pin);
        if (res?.ok) {
          setStatus("Unlocked.", "ok");
          window.flickpayConfig.pinOkOpenSettings();
        } else {
          setStatus("Incorrect PIN.", "error");
          setPin("");
        }
      } catch {
        setStatus("Error verifying PIN.", "error");
      } finally {
        unlockBtn.disabled = false;
      }
    }

    // Unlock button
    unlockBtn.addEventListener("click", tryUnlock);

    // Close X: same behaviour as Escape / closePin
    document.getElementById("closeX")?.addEventListener("click", () => {
      if (window.flickpayConfig?.closePin) window.flickpayConfig.closePin();
    });

    // Touch keypad clicks
    document.addEventListener("click", (e) => {
      const btn = e.target.closest(".pinKey");
      if (!btn) return;

      const action = btn.getAttribute("data-action");
      const key = btn.getAttribute("data-key");

      if (action === "clear") {
        setPin("");
        return;
      }

      if (action === "back") {
        setPin(pin.slice(0, -1));
        return;
      }

      if (key) {
        setPin(pin + key);
      }
    });

    // Physical keyboard support WITHOUT focusing an input (prevents Windows OSK)
    document.addEventListener("keydown", (e) => {
      // allow Esc to close
      if (e.key === "Escape") {
        if (window.flickpayConfig?.closePin) window.flickpayConfig.closePin();
        return;
      }

      // Enter to unlock
      if (e.key === "Enter") {
        tryUnlock();
        return;
      }

      // Backspace deletes
      if (e.key === "Backspace") {
        e.preventDefault();
        setPin(pin.slice(0, -1));
        return;
      }

      // Delete clears
      if (e.key === "Delete") {
        e.preventDefault();
        setPin("");
        return;
      }

      // Digits (top row or numpad)
      if (/^\d$/.test(e.key)) {
        e.preventDefault();
        if (pin.length < 4) setPin(pin + e.key);
        return;
      }
    });

    // Optional: tap card clears status only (no focus, no OSK)
    card.addEventListener("click", () => setStatus(""));

    // init
    setPin("");
  </script>
</body>
</html>
